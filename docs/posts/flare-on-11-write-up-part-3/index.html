<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Flare-On 11 Write-Up Part 3" /><meta property="og:locale" content="en" /><meta name="description" content="This is the third post in my Flare-On 11 series. If you haven’t already, I recommend checking out the previous writeup to get up to speed." /><meta property="og:description" content="This is the third post in my Flare-On 11 series. If you haven’t already, I recommend checking out the previous writeup to get up to speed." /><link rel="canonical" href="https://vik0t0r.github.io/posts/flare-on-11-write-up-part-3/" /><meta property="og:url" content="https://vik0t0r.github.io/posts/flare-on-11-write-up-part-3/" /><meta property="og:site_name" content="vik0t0r" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-12-07T15:07:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Flare-On 11 Write-Up Part 3" /><meta name="twitter:site" content="@vik0t0r" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-12-07T15:07:00+01:00","datePublished":"2024-12-07T15:07:00+01:00","description":"This is the third post in my Flare-On 11 series. If you haven’t already, I recommend checking out the previous writeup to get up to speed.","headline":"Flare-On 11 Write-Up Part 3","mainEntityOfPage":{"@type":"WebPage","@id":"https://vik0t0r.github.io/posts/flare-on-11-write-up-part-3/"},"url":"https://vik0t0r.github.io/posts/flare-on-11-write-up-part-3/"}</script><title>Flare-On 11 Write-Up Part 3 | vik0t0r</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="vik0t0r"><meta name="application-name" content="vik0t0r"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=/&register=true" ></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="https://vik0t0r.github.io/assets/img/avatar.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">vik0t0r</a><p class="site-subtitle fst-italic mb-0">Hacker wannabe</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/vik0t0r" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/vik0t0r" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['vik0t0r','proton.me'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/vik0t0r/" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Flare-On 11 Write-Up Part 3</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Flare-On 11 Write-Up Part 3</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1733580420" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Dec 7, 2024 </time> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/vik0t0r">Victor de Pedraza Ajenjo</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="3851 words" > <em>21 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Flare-On 11 Write-Up Part 3</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Flare-On 11 Write-Up Part 3</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><p>This is the third post in my <strong>Flare-On 11</strong> series. If you haven’t already, I recommend checking out the <a href="/posts/flare-on-11-write-up-part-2/">previous writeup</a> to get up to speed.</p><p>As with the first post, you can find supplementary resources, including all the scripts I used during the CTF, in <a href="https://github.com/vik0t0r/flare-on-11">this repository</a>.</p><h2 id="challenge-5---sshd"><span class="me-2">Challenge 5 - sshd</span><a href="#challenge-5---sshd" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><blockquote><p>Our server in the FLARE Intergalactic HQ has crashed! Now criminals are trying to sell me my own data!!! Do your part, random internet hacker, to help FLARE out and tell us what data they stole! We used the best forensic preservation technique of just copying all the files on the system for you.</p></blockquote><p>From my perspective, this was the hardest challenge to solve—and my favorite so far. It references the infamous <strong>xz utils backdoor</strong> from February. In this challenge, we are given the files from a Linux server to analyze.</p><h4 id="step-1-exploring-the-filesystem"><span class="me-2">Step 1: Exploring the filesystem</span><a href="#step-1-exploring-the-filesystem" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>We begin by extracting the archive and listing its contents:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">ls
</span>bin  boot  dev  etc  fmnt  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
</pre></table></code></div></div><p>After exploring the filesystem, we find an interesting file in the root directory:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="nb">ls</span> <span class="nt">-lh</span> root/
total 4.0K
<span class="nt">-rw-r--r--</span> 1 root root    0 Aug  3 21:21 anonymized.phony
<span class="nt">-rw-r--r--</span> 1 root root 2.3K Sep 11 22:55 flag.txt
<span class="nb">cat </span>root/flag.txt
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣧⠀⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣿⣧⠀⠀⠀⢰⡿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⡟⡆⠀⠀⣿⡇⢻⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⠀⣿⠀⢰⣿⡇⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⡄⢸⠀⢸⣿⡇⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣿⡇⢸⡄⠸⣿⡇⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢿⣿⢸⡅⠀⣿⢠⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⣿⣿⣥⣾⣿⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣆⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⡿⡿⣿⣿⡿⡅⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⠉⠀⠉⡙⢔⠛⣟⢋⠦⢵⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣾⣄⠀⠀⠁⣿⣯⡥⠃⠀⢳⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣴⣿⡇⠀⠀⠀⠐⠠⠊⢀⠀⢸⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⢀⣴⣿⣿⣿⡿⠀⠀⠀⠀⠀⠈⠁⠀⠀⠘⣿⣄⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⣠⣿⣿⣿⣿⣿⡟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⣿⣷⡀⠀⠀⠀
⠀⠀⠀⠀⣾⣿⣿⣿⣿⣿⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⣿⣿⣧⠀⠀
⠀⠀⠀⡜⣭⠤⢍⣿⡟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⢛⢭⣗⠀
⠀⠀⠀⠁⠈⠀⠀⣀⠝⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠄⠠⠀⠀⠰⡅
⠀⠀⠀⢀⠀⠀⡀⠡⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠔⠠⡕⠀
⠀⠀⠀⠀⣿⣷⣶⠒⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢰⠀⠀⠀⠀
⠀⠀⠀⠀⠘⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠰⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠈⢿⣿⣦⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⠊⠉⢆⠀⠀⠀⠀
⠀⢀⠤⠀⠀⢤⣤⣽⣿⣿⣦⣀⢀⡠⢤⡤⠄⠀⠒⠀⠁⠀⠀⠀⢘⠔⠀⠀⠀⠀
⠀⠀⠀⡐⠈⠁⠈⠛⣛⠿⠟⠑⠈⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠉⠑⠒⠀⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
<span class="k">if </span>only it were that easy......
</pre></table></code></div></div><p>Clearly, this is a decoy. Digging further, we discover a core dump from the sshd process. The challenge name starts to make sense:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>tree
...
    │   ├── private
    │   ├── shells.state
    │   ├── systemd
    │   │   ├── catalog
    │   │   │   └── database
    │   │   ├── coredump
    │   │   │   └── sshd.core.93794.0.0.11.1725917676
    │   │   ├── deb-systemd-helper-enabled
    │   │   │   ├── apt-daily.timer.dsh-also
    │   │   │   ├── apt-daily-upgrade.timer.dsh-also
...
</pre></table></code></div></div><h4 id="step-2-opening-the-core-dump"><span class="me-2">Step 2: Opening the core dump</span><a href="#step-2-opening-the-core-dump" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>We open the core dump with gdb for analysis. For better functionality, I used gef (GDB Enhanced Features).</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>gdb usr/sbin/sshd var/lib/systemd/coredump/sshd.core.93794.0.0.11.1725917676
</pre></table></code></div></div><p><a href="https://vik0t0r.github.io/assets/img/flareon11_3/backtrace_empty.png" class="popup img-link shimmer"><img src="https://vik0t0r.github.io/assets/img/flareon11_3/backtrace_empty.png" alt="img-description" width="1000" loading="lazy"></a></p><p>Apparently sshd crashed on a call to liblzma. At this point I understood the reference to the <strong>xz utils backdoor</strong> and I started to do some research. <a href="https://www.youtube.com/watch?v=Q6ovtLdSbEA">This video</a> and <a href="https://github.com/amlweems/xzbot">this github repository</a> helped me a lot by explaining the inner workings of the original backdoor.</p><h4 id="step-3-donwloading-debug-symbols"><span class="me-2">Step 3: Donwloading debug symbols:</span><a href="#step-3-donwloading-debug-symbols" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>To improve the backtrace (replacing <code class="language-plaintext highlighter-rouge">??</code> with function names), I installed the same Debian version in a Docker container and downloaded the appropriate debug symbols.</p><p><strong>Setting Up the Environment</strong></p><p>We create the following <code class="language-plaintext highlighter-rouge">docker-compose.yaml</code>, We can determine the system’s Debian version using the file <code class="language-plaintext highlighter-rouge">/etc/debian_version</code>:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.8'</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">debian-container</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">jrei/systemd-debian:12</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">debian_shell</span>
    <span class="na">stdin_open</span><span class="pi">:</span> <span class="kc">true</span>  <span class="c1"># Keep stdin open to allow interactive shell</span>
    <span class="na">tty</span><span class="pi">:</span> <span class="kc">true</span>         <span class="c1"># Allocate a pseudo-TTY for the container</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./ssh_container:/mnt</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">/bin/bash</span>

<span class="na">volumes</span><span class="pi">:</span>
  <span class="na">ssh_container</span><span class="pi">:</span>
</pre></table></code></div></div><p>Then we run and attach to the docker getting a shell:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>docker-compose up
docker attach debian_shell
</pre></table></code></div></div><p>Then we update the docker package repositories to enable debug sysmbols and source code repositories by writting to <code class="language-plaintext highlighter-rouge">/etc/apt/sources.list</code>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>deb http://deb.debian.org/debian-debug/ bookworm-debug main
deb-src http://deb.debian.org/debian bookworm main
</pre></table></code></div></div><p>And then I installed the necessary dependencies:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>apt update

apt <span class="nb">install </span>nano
apt <span class="nb">install </span>dpkg-dev
apt <span class="nb">install </span>gdb
<span class="c"># GEF dependencies</span>
apt <span class="nb">install </span>curl
apt <span class="nb">install </span>python3
apt <span class="nb">install </span>file

<span class="c"># install GEF:</span>
bash <span class="nt">-c</span> <span class="s2">"</span><span class="si">$(</span>wget https://gef.blah.cat/sh <span class="nt">-O</span> -<span class="si">)</span><span class="s2">"</span>

<span class="c"># fix for `UnicodeEncodeError` on GEF:</span>
<span class="nb">export </span><span class="nv">LC_ALL</span><span class="o">=</span>C.UTF-8
</pre></table></code></div></div><p>Now I was ready to download the debug symbols and the source code for sshd:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c"># download dbgsymbols</span>
apt <span class="nb">install </span>openssh-server-dbgsy

<span class="c"># download source code on openssh-9.2p1/</span>
apt <span class="nb">source </span>openssh-server
</pre></table></code></div></div><p>Next, we run gdb, load the core dump using the binary from the Docker instance, and include the source files in gdb for debugging.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>gdb /usr/sbin/sshd /mnt/var/lib/systemd/coredump/sshd.core.93794.0.0.11.1725917676

gef&gt; directory openssh-9.2p1/
Source directories searched: /openssh-9.2p1:<span class="nv">$cdir</span>:<span class="nv">$cwd</span>
</pre></table></code></div></div><p>With debug symbols loaded, the backtrace becomes more meaningful:</p><p><a href="https://vik0t0r.github.io/assets/img/flareon11_3/backtrace.png" class="popup img-link shimmer"><img src="https://vik0t0r.github.io/assets/img/flareon11_3/backtrace.png" alt="img-description" width="1000" loading="lazy"></a></p><p>Now we can analyze each frame and print the context, frame 10 is the last one for which we have symbols:</p><p><a href="https://vik0t0r.github.io/assets/img/flareon11_3/frame10.png" class="popup img-link shimmer"><img src="https://vik0t0r.github.io/assets/img/flareon11_3/frame10.png" alt="img-description" width="1000" loading="lazy"></a></p><p>As we can see the last function called is <code class="language-plaintext highlighter-rouge">RSA_public_decrypt</code>.</p><h4 id="step-4-finding-the-backdoor-function"><span class="me-2">Step 4: Finding the backdoor function</span><a href="#step-4-finding-the-backdoor-function" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>So if we did paid attention at how the xz backdoor did its thing, we will know that it used linking magic to replace the call to <code class="language-plaintext highlighter-rouge">RSA_public_decrypt</code>, with one of the functions. At this moment is when I though about static analyzing the liblzma library provided on the filesystem.</p><p>We need to find wich function is executed when we call <code class="language-plaintext highlighter-rouge">RSA_public_decrypt</code>. For this I’ll be running sshd with the malicious liblzma and attaching to it with gdb.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nb">rm</span> /usr/lib/x86_64-linux-gnu/liblzma.so.5.4.1
<span class="nb">cp</span> /mnt/usr/lib/x86_64-linux-gnu/liblzma.so.5.4.1 /usr/lib/x86_64-linux-gnu/liblzma.so.5.4.1

<span class="c"># we need to run this without systemd</span>
/sbin/sshd
gdb <span class="nt">-p</span> PID
</pre></table></code></div></div><p>Now we can see that liblzma is loaded with:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>gef➤  vmmap liblzma
<span class="o">[</span> Legend:  Code | Heap | Stack <span class="o">]</span>
Start              End                Offset             Perm Path
0x00007f37e2fcd000 0x00007f37e2fd1000 0x0000000000000000 r-- /usr/lib/x86_64-linux-gnu/liblzma.so.5.4.1
0x00007f37e2fd1000 0x00007f37e2ff0000 0x0000000000004000 r-x /usr/lib/x86_64-linux-gnu/liblzma.so.5.4.1
0x00007f37e2ff0000 0x00007f37e2ffe000 0x0000000000023000 r-- /usr/lib/x86_64-linux-gnu/liblzma.so.5.4.1
0x00007f37e2ffe000 0x00007f37e2fff000 0x0000000000030000 r-- /usr/lib/x86_64-linux-gnu/liblzma.so.5.4.1
0x00007f37e2fff000 0x00007f37e3000000 0x0000000000031000 rw- /usr/lib/x86_64-linux-gnu/liblzma.so.5.4.1
</pre></table></code></div></div><p>First we search for the function definitions, only one is defined inside /usr/sbin/sshd scope:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>gef➤  i functions RSA_public_decrypt
All functions matching regular expression <span class="s2">"RSA_public_decrypt"</span>:

Non-debugging symbols:
0x000055e181c0b2b0  RSA_public_decrypt@plt
0x00007f37e34495a0  RSA_public_decrypt@plt
0x00007f37e35f0c90  RSA_public_decrypt
gef➤  vmmap 0x000055e181c0b2b0
<span class="o">[</span> Legend:  Code | Heap | Stack <span class="o">]</span>
Start              End                Offset             Perm Path
0x000055e181c0b000 0x000055e181cd9000 0x000000000000d000 r-x /usr/sbin/sshd
gef➤  vmmap 0x00007f37e34495a0
<span class="o">[</span> Legend:  Code | Heap | Stack <span class="o">]</span>
Start              End                Offset             Perm Path
0x00007f37e343f000 0x00007f37e36bb000 0x00000000000c5000 r-x /usr/lib/x86_64-linux-gnu/libcrypto.so.3
gef➤  vmmap 0x00007f37e35f0c90
<span class="o">[</span> Legend:  Code | Heap | Stack <span class="o">]</span>
Start              End                Offset             Perm Path
0x00007f37e343f000 0x00007f37e36bb000 0x00000000000c5000 r-x /usr/lib/x86_64-linux-gnu/libcrypto.so.3
</pre></table></code></div></div><p>And now we can print the instructions at the PLT:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>gef➤  x/5i 0x000055e181c0b2b0
   0x55e181c0b2b0 &lt;RSA_public_decrypt@plt&gt;:	jmp    QWORD PTR <span class="o">[</span>rip+0x125f62]        <span class="c"># 0x55e181d31218 &lt;RSA_public_decrypt@got.plt&gt;</span>
   0x55e181c0b2b6 &lt;RSA_public_decrypt@plt+6&gt;:	push   0x28
   0x55e181c0b2bb &lt;RSA_public_decrypt@plt+11&gt;:	jmp    0x55e181c0b020
   0x55e181c0b2c0 &lt;fork@plt&gt;:	jmp    QWORD PTR <span class="o">[</span>rip+0x125f5a]        <span class="c"># 0x55e181d31220 &lt;fork@got.plt&gt;</span>
   0x55e181c0b2c6 &lt;fork@plt+6&gt;:	push   0x29
</pre></table></code></div></div><p>As we can see, our target function address is stored on address <code class="language-plaintext highlighter-rouge">0x55e181d31218</code>, with the following commands we can print it. See how the address for <code class="language-plaintext highlighter-rouge">RSA_public_decrypt</code> is on liblzma.so.5.4.1 which shouldn’t be the case.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>gef➤  x/a 0x55e181d31218
0x55e181d31218 &lt;RSA_public_decrypt@got.plt&gt;:	0x7f37e2fd6820
gef➤  vmmap 0x7f37e2fd6820
<span class="o">[</span> Legend:  Code | Heap | Stack <span class="o">]</span>
Start              End                Offset             Perm Path
0x00007f37e2fd1000 0x00007f37e2ff0000 0x0000000000004000 r-x /usr/lib/x86_64-linux-gnu/liblzma.so.5.4.1
</pre></table></code></div></div><p>From now on, I’ll be calling this functionn <code class="language-plaintext highlighter-rouge">RSA_public_decrypt_hook</code>.</p><h4 id="step-5-analyzing-the-hook-function"><span class="me-2">Step 5: Analyzing the hook function</span><a href="#step-5-analyzing-the-hook-function" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>With this info, we can now open liblzma.so.4.1 with ghidra and search for this function, we simply need to use the memory map to change the base address to the one on hour runnning environment (in this case <code class="language-plaintext highlighter-rouge">0x7f37e2fcd000</code> which we got from the previous vmmap), jump to the address of the function <code class="language-plaintext highlighter-rouge">0x7f37e2fd6820</code>, and proceed to analyze it:</p><p><a href="https://vik0t0r.github.io/assets/img/flareon11_3/RSA_public_decrypt_hook.png" class="popup img-link shimmer"><img src="https://vik0t0r.github.io/assets/img/flareon11_3/RSA_public_decrypt_hook.png" alt="img-description" width="1000" loading="lazy"></a></p><p>We can properly decode system calls by running the script <code class="language-plaintext highlighter-rouge">ResolveX86orX64LinuxSyscallsScript.java</code>.</p><p>As we can see, this function does the following:</p><ol><li>Checks that the uid of the process is 0 (if not the proper RSA_public_decrypt will be called)<li>Allocates some memory with mmap()<li>Copies some data to that memory with memcpy()<li>Jumps into this memory with <code class="language-plaintext highlighter-rouge">(*ptrTarget)()</code> or <code class="language-plaintext highlighter-rouge">call r8</code></ol><p>For getting the source code of <code class="language-plaintext highlighter-rouge">ptrTarget</code> the easiest path is to run the backdoor, and break just before the <code class="language-plaintext highlighter-rouge">call</code> instruction is executed.</p><p>For this purpose I will be calling <code class="language-plaintext highlighter-rouge">RSA_public_decrypt_hook</code> from gdb, i have written the following c code:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;dlfcn.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span>
<span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func_ptr</span><span class="p">)();</span>  <span class="c1">// Define a function pointer type</span>


<span class="kt">char</span> <span class="n">payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x48</span><span class="p">,</span><span class="mh">0x7a</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0xc5</span><span class="p">,</span><span class="mh">0x94</span><span class="p">,</span><span class="mh">0x3d</span><span class="p">,</span><span class="mh">0xf6</span><span class="p">,</span><span class="mh">0x38</span><span class="p">,</span><span class="mh">0xa8</span><span class="p">,</span><span class="mh">0x18</span><span class="p">,</span><span class="mh">0x13</span><span class="p">,</span><span class="mh">0xe2</span><span class="p">,</span><span class="mh">0xde</span><span class="p">,</span><span class="mh">0x63</span><span class="p">,</span><span class="mh">0x18</span><span class="p">,</span><span class="mh">0xa5</span><span class="p">,</span><span class="mh">0x07</span><span class="p">,</span><span class="mh">0xf9</span><span class="p">,</span><span class="mh">0xa0</span><span class="p">,</span><span class="mh">0xba</span><span class="p">,</span><span class="mh">0x2d</span><span class="p">,</span><span class="mh">0xbb</span><span class="p">,</span><span class="mh">0x8a</span><span class="p">,</span><span class="mh">0x7b</span><span class="p">,</span><span class="mh">0xa6</span><span class="p">,</span><span class="mh">0x36</span><span class="p">,</span><span class="mh">0x66</span><span class="p">,</span><span class="mh">0xd0</span><span class="p">,</span><span class="mh">0x8d</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0xa6</span><span class="p">,</span><span class="mh">0x5e</span><span class="p">,</span><span class="mh">0xc9</span><span class="p">,</span><span class="mh">0x14</span><span class="p">,</span><span class="mh">0xd6</span><span class="p">,</span><span class="mh">0x6f</span><span class="p">,</span><span class="mh">0xf2</span><span class="p">,</span><span class="mh">0x36</span><span class="p">,</span><span class="mh">0x83</span><span class="p">,</span><span class="mh">0x9f</span><span class="p">,</span><span class="mh">0x4d</span><span class="p">,</span><span class="mh">0xcd</span><span class="p">,</span><span class="mh">0x71</span><span class="p">,</span><span class="mh">0x1a</span><span class="p">,</span><span class="mh">0x52</span><span class="p">,</span><span class="mh">0x86</span><span class="p">,</span><span class="mh">0x29</span><span class="p">,</span><span class="mh">0x55</span><span class="p">,</span><span class="mh">0x58</span><span class="p">,</span><span class="mh">0x58</span><span class="p">,</span><span class="mh">0xd1</span><span class="p">,</span><span class="mh">0xb7</span><span class="p">,</span><span class="mh">0xf9</span><span class="p">,</span><span class="mh">0xa7</span><span class="p">,</span><span class="mh">0xc2</span><span class="p">,</span><span class="mh">0x0d</span><span class="p">,</span><span class="mh">0x36</span><span class="p">,</span><span class="mh">0xde</span><span class="p">,</span><span class="mh">0x0e</span><span class="p">,</span><span class="mh">0x19</span><span class="p">,</span><span class="mh">0xea</span><span class="p">,</span><span class="mh">0xa3</span><span class="p">,</span><span class="mh">0x05</span><span class="p">,</span><span class="mh">0x96</span><span class="p">,</span><span class="mh">0xda</span><span class="p">,</span><span class="mh">0x59</span><span class="p">,</span><span class="mh">0xb9</span><span class="p">,</span><span class="mh">0xb9</span><span class="p">,</span><span class="mh">0x0d</span><span class="p">,</span><span class="mh">0x17</span><span class="p">,</span><span class="mh">0x8f</span><span class="p">,</span><span class="mh">0x41</span><span class="p">,</span><span class="mh">0x42</span><span class="p">,</span><span class="mh">0x3d</span><span class="p">,</span><span class="mh">0x7e</span><span class="p">,</span><span class="mh">0xeb</span><span class="p">,</span><span class="mh">0x15</span><span class="p">,</span><span class="mh">0x07</span><span class="p">,</span><span class="mh">0xb5</span><span class="p">,</span><span class="mh">0xdc</span><span class="p">,</span><span class="mh">0x03</span><span class="p">,</span><span class="mh">0x9c</span><span class="p">,</span><span class="mh">0xb8</span><span class="p">,</span><span class="mh">0x49</span><span class="p">,</span><span class="mh">0xa8</span><span class="p">,</span><span class="mh">0x59</span><span class="p">,</span><span class="mh">0x98</span><span class="p">,</span><span class="mh">0xcc</span><span class="p">,</span><span class="mh">0x61</span><span class="p">,</span><span class="mh">0x1f</span><span class="p">,</span><span class="mh">0x37</span><span class="p">,</span><span class="mh">0x9b</span><span class="p">,</span><span class="mh">0x4d</span><span class="p">,</span><span class="mh">0x0a</span><span class="p">,</span><span class="mh">0xf2</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0xbd</span><span class="p">,</span><span class="mh">0xab</span><span class="p">,</span><span class="mh">0x37</span><span class="p">,</span><span class="mh">0x2d</span><span class="p">,</span><span class="mh">0x0c</span><span class="p">,</span><span class="mh">0x37</span><span class="p">,</span><span class="mh">0x16</span><span class="p">,</span><span class="mh">0xe2</span><span class="p">,</span><span class="mh">0xa3</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x4b</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x51</span><span class="p">,</span><span class="mh">0xad</span><span class="p">,</span><span class="mh">0x49</span><span class="p">,</span><span class="mh">0xa9</span><span class="p">,</span><span class="mh">0x4a</span><span class="p">,</span><span class="mh">0x1a</span><span class="p">,</span><span class="mh">0x95</span><span class="p">,</span><span class="mh">0x8e</span><span class="p">,</span><span class="mh">0x26</span><span class="p">,</span><span class="mh">0x6b</span><span class="p">,</span><span class="mh">0x98</span><span class="p">,</span><span class="mh">0x91</span><span class="p">,</span><span class="mh">0x6a</span><span class="p">,</span><span class="mh">0xb0</span><span class="p">,</span><span class="mh">0xa7</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0xee</span><span class="p">,</span><span class="mh">0xcb</span><span class="p">,</span><span class="mh">0xd0</span><span class="p">,</span><span class="mh">0xf3</span><span class="p">,</span><span class="mh">0xd2</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x47</span><span class="p">,</span><span class="mh">0xd0</span><span class="p">,</span><span class="mh">0x5f</span><span class="p">,</span><span class="mh">0x9e</span><span class="p">,</span><span class="mh">0x67</span><span class="p">,</span><span class="mh">0xa9</span><span class="p">,</span><span class="mh">0xf1</span><span class="p">,</span><span class="mh">0x2d</span><span class="p">,</span><span class="mh">0x6c</span><span class="p">,</span><span class="mh">0x15</span><span class="p">,</span><span class="mh">0x8d</span><span class="p">,</span><span class="mh">0x6f</span><span class="p">,</span><span class="mh">0xa5</span><span class="p">,</span><span class="mh">0xbd</span><span class="p">,</span><span class="mh">0x32</span><span class="p">,</span><span class="mh">0xd5</span><span class="p">,</span><span class="mh">0x8a</span><span class="p">,</span><span class="mh">0x17</span><span class="p">,</span><span class="mh">0x6d</span><span class="p">,</span><span class="mh">0x7e</span><span class="p">,</span><span class="mh">0x61</span><span class="p">,</span><span class="mh">0x85</span><span class="p">,</span><span class="mh">0x16</span><span class="p">,</span><span class="mh">0xe6</span><span class="p">,</span><span class="mh">0x6c</span><span class="p">,</span><span class="mh">0x31</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="mh">0x14</span><span class="p">,</span><span class="mh">0x03</span><span class="p">,</span><span class="mh">0x8a</span><span class="p">,</span><span class="mh">0x9a</span><span class="p">,</span><span class="mh">0x4f</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0xac</span><span class="p">,</span><span class="mh">0xea</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="mh">0x5c</span><span class="p">,</span><span class="mh">0x2f</span><span class="p">,</span><span class="mh">0x74</span><span class="p">,</span><span class="mh">0x0d</span><span class="p">,</span><span class="mh">0x9f</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x0a</span><span class="p">,</span><span class="mh">0xb6</span><span class="p">,</span><span class="mh">0x8a</span><span class="p">,</span><span class="mh">0xda</span><span class="p">,</span><span class="mh">0x79</span><span class="p">,</span><span class="mh">0x42</span><span class="p">,</span><span class="mh">0x3a</span><span class="p">,</span><span class="mh">0x70</span><span class="p">,</span><span class="mh">0x2a</span><span class="p">,</span><span class="mh">0x99</span><span class="p">,</span><span class="mh">0x17</span><span class="p">,</span><span class="mh">0xfb</span><span class="p">,</span><span class="mh">0xbd</span><span class="p">,</span><span class="mh">0x95</span><span class="p">,</span><span class="mh">0x53</span><span class="p">,</span><span class="mh">0x51</span><span class="p">,</span><span class="mh">0x63</span><span class="p">,</span><span class="mh">0xbc</span><span class="p">,</span><span class="mh">0x83</span><span class="p">,</span><span class="mh">0x94</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0x7b</span><span class="p">,</span><span class="mh">0x81</span><span class="p">,</span><span class="mh">0x70</span><span class="p">,</span><span class="mh">0xb7</span><span class="p">,</span><span class="mh">0x82</span><span class="p">,</span><span class="mh">0x64</span><span class="p">,</span><span class="mh">0x1e</span><span class="p">,</span><span class="mh">0x3c</span><span class="p">,</span><span class="mh">0x1f</span><span class="p">,</span><span class="mh">0xa0</span><span class="p">,</span><span class="mh">0xad</span><span class="p">,</span><span class="mh">0x4f</span><span class="p">,</span><span class="mh">0x7a</span><span class="p">,</span><span class="mh">0xe0</span><span class="p">,</span><span class="mh">0xe3</span><span class="p">,</span><span class="mh">0x81</span><span class="p">,</span><span class="mh">0xed</span><span class="p">,</span><span class="mh">0xbd</span><span class="p">,</span><span class="mh">0x39</span><span class="p">,</span><span class="mh">0x5e</span><span class="p">,</span><span class="mh">0xab</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0xe3</span><span class="p">,</span><span class="mh">0x45</span><span class="p">,</span><span class="mh">0x2d</span><span class="p">,</span><span class="mh">0xb2</span><span class="p">,</span><span class="mh">0xdc</span><span class="p">,</span><span class="mh">0x0f</span><span class="p">,</span><span class="mh">0xbc</span><span class="p">,</span><span class="mh">0x79</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x15</span><span class="p">,</span><span class="mh">0x03</span><span class="p">,</span><span class="mh">0x71</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0xe8</span><span class="p">,</span><span class="mh">0x2e</span><span class="p">,</span><span class="mh">0x9f</span><span class="p">,</span><span class="mh">0xa9</span><span class="p">,</span><span class="mh">0x15</span><span class="p">,</span><span class="mh">0x43</span><span class="p">,</span><span class="mh">0x06</span><span class="p">,</span><span class="mh">0x15</span><span class="p">,</span><span class="mh">0xa3</span><span class="p">,</span><span class="mh">0xc3</span><span class="p">,</span><span class="mh">0x94</span><span class="p">,</span><span class="mh">0x78</span><span class="p">,</span><span class="mh">0x21</span><span class="p">,</span><span class="mh">0x96</span><span class="p">,</span><span class="mh">0x69</span><span class="p">,</span><span class="mh">0x73</span><span class="p">,</span><span class="mh">0x9e</span><span class="p">,</span><span class="mh">0xaa</span><span class="p">,</span><span class="mh">0x72</span><span class="p">,</span><span class="mh">0x1b</span><span class="p">,</span><span class="mh">0x7c</span><span class="p">,</span><span class="mh">0x52</span><span class="p">,</span><span class="mh">0x32</span><span class="p">,</span><span class="mh">0x6b</span><span class="p">,</span><span class="mh">0x23</span><span class="p">,</span><span class="mh">0xad</span><span class="p">,</span><span class="mh">0x14</span><span class="p">,</span><span class="mh">0xef</span><span class="p">,</span><span class="mh">0x31</span><span class="p">,</span><span class="mh">0xfd</span><span class="p">,</span><span class="mh">0x2a</span><span class="p">,</span><span class="mh">0xcf</span><span class="p">,</span><span class="mh">0xa3</span><span class="p">,</span><span class="mh">0xae</span><span class="p">,</span><span class="mh">0xf9</span><span class="p">,</span><span class="mh">0xde</span><span class="p">,</span><span class="mh">0xca</span><span class="p">,</span><span class="mh">0x0c</span><span class="p">,</span><span class="mh">0xb6</span><span class="p">,</span><span class="mh">0x57</span><span class="p">,</span><span class="mh">0x41</span><span class="p">,</span><span class="mh">0xa7</span><span class="p">,</span><span class="mh">0x73</span><span class="p">,</span><span class="mh">0xce</span><span class="p">,</span><span class="mh">0x9f</span><span class="p">,</span><span class="mh">0xb6</span><span class="p">,</span><span class="mh">0x60</span><span class="p">,</span><span class="mh">0x96</span><span class="p">,</span><span class="mh">0x3d</span><span class="p">,</span><span class="mh">0xe2</span><span class="p">,</span><span class="mh">0xac</span><span class="p">,</span><span class="mh">0x4b</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x78</span><span class="p">,</span><span class="mh">0x63</span><span class="p">,</span><span class="mh">0x8e</span><span class="p">,</span><span class="mh">0xe1</span><span class="p">,</span><span class="mh">0x71</span><span class="p">,</span><span class="mh">0xc1</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0xe6</span><span class="p">,</span><span class="mh">0xc1</span><span class="p">,</span><span class="mh">0x8b</span><span class="p">,</span><span class="mh">0x87</span><span class="p">,</span><span class="mh">0x12</span><span class="p">,</span><span class="mh">0xa6</span><span class="p">,</span><span class="mh">0x45</span><span class="p">,</span><span class="mh">0xe0</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="mh">0x64</span><span class="p">,</span><span class="mh">0x1c</span><span class="p">,</span><span class="mh">0xc9</span><span class="p">,</span><span class="mh">0xb2</span><span class="p">,</span><span class="mh">0x81</span><span class="p">,</span><span class="mh">0xeb</span><span class="p">,</span><span class="mh">0x3e</span><span class="p">,</span><span class="mh">0x3d</span><span class="p">,</span><span class="mh">0x3e</span><span class="p">,</span><span class="mh">0x48</span><span class="p">,</span><span class="mh">0x54</span><span class="p">,</span><span class="mh">0x64</span><span class="p">,</span><span class="mh">0x83</span><span class="p">,</span><span class="mh">0xa9</span><span class="p">,</span><span class="mh">0x98</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span><span class="mh">0xb1</span><span class="p">,</span><span class="mh">0x86</span><span class="p">,</span><span class="mh">0xa2</span><span class="p">,</span><span class="mh">0x2e</span><span class="p">,</span><span class="mh">0x84</span><span class="p">,</span><span class="mh">0x17</span><span class="p">,</span><span class="mh">0x25</span><span class="p">,</span><span class="mh">0xc8</span><span class="p">,</span><span class="mh">0xcb</span><span class="p">,</span><span class="mh">0xc9</span><span class="p">,</span><span class="mh">0xba</span><span class="p">,</span><span class="mh">0x05</span><span class="p">,</span><span class="mh">0xd2</span><span class="p">,</span><span class="mh">0xca</span><span class="p">,</span><span class="mh">0x8f</span><span class="p">,</span><span class="mh">0x1e</span><span class="p">,</span><span class="mh">0xc0</span><span class="p">,</span><span class="mh">0x69</span><span class="p">,</span><span class="mh">0x1f</span><span class="p">,</span><span class="mh">0x9d</span><span class="p">,</span><span class="mh">0x42</span><span class="p">,</span><span class="mh">0x75</span><span class="p">,</span><span class="mh">0x6f</span><span class="p">,</span><span class="mh">0x7b</span><span class="p">,</span><span class="mh">0x42</span><span class="p">,</span><span class="mh">0x3e</span><span class="p">,</span><span class="mh">0xa1</span><span class="p">,</span><span class="mh">0x9c</span><span class="p">,</span><span class="mh">0xe6</span><span class="p">,</span><span class="mh">0x85</span><span class="p">,</span><span class="mh">0xdf</span><span class="p">,</span><span class="mh">0x1f</span><span class="p">,</span><span class="mh">0x35</span><span class="p">,</span><span class="mh">0x15</span><span class="p">,</span><span class="mh">0x7b</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0xac</span><span class="p">,</span><span class="mh">0x66</span><span class="p">,</span><span class="mh">0x5d</span><span class="p">,</span><span class="mh">0xc3</span><span class="p">,</span><span class="mh">0xf0</span><span class="p">,</span><span class="mh">0x14</span><span class="p">,</span><span class="mh">0x7c</span><span class="p">,</span><span class="mh">0xc6</span><span class="p">,</span><span class="mh">0xc5</span><span class="p">,</span><span class="mh">0x6c</span><span class="p">,</span><span class="mh">0xa5</span><span class="p">,</span><span class="mh">0x6b</span><span class="p">,</span><span class="mh">0x90</span><span class="p">,</span><span class="mh">0xc4</span><span class="p">,</span><span class="mh">0x57</span><span class="p">,</span><span class="mh">0x06</span><span class="p">,</span><span class="mh">0x83</span><span class="p">,</span><span class="mh">0xf8</span><span class="p">,</span><span class="mh">0xd8</span><span class="p">,</span><span class="mh">0x69</span><span class="p">,</span><span class="mh">0x2d</span><span class="p">,</span><span class="mh">0xea</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="mh">0x1f</span><span class="p">,</span><span class="mh">0xfb</span><span class="p">,</span><span class="mh">0x14</span><span class="p">,</span><span class="mh">0x77</span><span class="p">,</span><span class="mh">0x33</span><span class="p">,</span><span class="mh">0xed</span><span class="p">,</span><span class="mh">0x77</span><span class="p">,</span><span class="mh">0x53</span><span class="p">,</span><span class="mh">0x77</span><span class="p">,</span><span class="mh">0x36</span><span class="p">,</span><span class="mh">0x27</span><span class="p">,</span><span class="mh">0xae</span><span class="p">,</span><span class="mh">0xc3</span><span class="p">,</span><span class="mh">0xdc</span><span class="p">,</span><span class="mh">0x25</span><span class="p">,</span><span class="mh">0x57</span><span class="p">,</span><span class="mh">0xe7</span><span class="p">,</span><span class="mh">0xd9</span><span class="p">,</span><span class="mh">0x5b</span><span class="p">,</span><span class="mh">0xd5</span><span class="p">,</span><span class="mh">0x98</span><span class="p">,</span><span class="mh">0x3b</span><span class="p">,</span><span class="mh">0xa7</span><span class="p">,</span><span class="mh">0x84</span><span class="p">,</span><span class="mh">0xaf</span><span class="p">,</span><span class="mh">0x12</span><span class="p">,</span><span class="mh">0xfb</span><span class="p">,</span><span class="mh">0xfe</span><span class="p">,</span><span class="mh">0x06</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x70</span><span class="p">,</span><span class="mh">0x27</span><span class="p">,</span><span class="mh">0x2d</span><span class="p">,</span><span class="mh">0xe4</span><span class="p">,</span><span class="mh">0xb9</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0xa6</span><span class="p">,</span><span class="mh">0x7c</span><span class="p">,</span><span class="mh">0x5b</span><span class="p">,</span><span class="mh">0x1e</span><span class="p">,</span><span class="mh">0x8c</span><span class="p">,</span><span class="mh">0xf7</span><span class="p">,</span><span class="mh">0x49</span><span class="p">,</span><span class="mh">0x74</span><span class="p">,</span><span class="mh">0x3a</span><span class="p">,</span><span class="mh">0xad</span><span class="p">,</span><span class="mh">0xf0</span><span class="p">,</span><span class="mh">0x03</span><span class="p">,</span><span class="mh">0x71</span><span class="p">,</span><span class="mh">0xc4</span><span class="p">,</span><span class="mh">0x96</span><span class="p">,</span><span class="mh">0x5f</span><span class="p">,</span><span class="mh">0xed</span><span class="p">,</span><span class="mh">0x5d</span><span class="p">,</span><span class="mh">0x53</span><span class="p">,</span><span class="mh">0x3b</span><span class="p">,</span><span class="mh">0x39</span><span class="p">,</span><span class="mh">0x04</span><span class="p">,</span><span class="mh">0x77</span><span class="p">,</span><span class="mh">0x85</span><span class="p">,</span><span class="mh">0xf1</span><span class="p">,</span><span class="mh">0x84</span><span class="p">,</span><span class="mh">0x3a</span><span class="p">,</span><span class="mh">0xfc</span><span class="p">,</span><span class="mh">0xda</span><span class="p">,</span><span class="mh">0xbe</span><span class="p">,</span><span class="mh">0x7c</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0x69</span><span class="p">,</span><span class="mh">0xbd</span><span class="p">,</span><span class="mh">0xe7</span><span class="p">,</span><span class="mh">0x91</span><span class="p">,</span><span class="mh">0xd4</span><span class="p">,</span><span class="mh">0x3a</span><span class="p">,</span><span class="mh">0xc6</span><span class="p">,</span><span class="mh">0xbd</span><span class="p">,</span><span class="mh">0xe9</span><span class="p">,</span><span class="mh">0xcb</span><span class="p">,</span><span class="mh">0x0a</span><span class="p">,</span><span class="mh">0x7b</span><span class="p">,</span><span class="mh">0xdd</span><span class="p">,</span><span class="mh">0xc7</span><span class="p">,</span><span class="mh">0x75</span><span class="p">,</span><span class="mh">0xb4</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x6a</span><span class="p">,</span><span class="mh">0x53</span><span class="p">,</span><span class="mh">0x63</span><span class="p">,</span><span class="mh">0x43</span><span class="p">,</span><span class="mh">0x31</span><span class="p">,</span><span class="mh">0x7c</span><span class="p">,</span><span class="mh">0x3f</span><span class="p">,</span><span class="mh">0x32</span><span class="p">,</span><span class="mh">0xdf</span><span class="p">,</span><span class="mh">0xae</span><span class="p">,</span><span class="mh">0x7d</span><span class="p">,</span><span class="mh">0xd6</span><span class="p">,</span><span class="mh">0xda</span><span class="p">,</span><span class="mh">0x84</span><span class="p">,</span><span class="mh">0xb5</span><span class="p">,</span><span class="mh">0x3e</span><span class="p">,</span><span class="mh">0xc7</span><span class="p">,</span><span class="mh">0x17</span><span class="p">,</span><span class="mh">0x38</span><span class="p">,</span><span class="mh">0x2b</span><span class="p">,</span><span class="mh">0x84</span><span class="p">,</span><span class="mh">0x67</span><span class="p">,</span><span class="mh">0x0e</span><span class="p">,</span><span class="mh">0xfe</span><span class="p">,</span><span class="mh">0xec</span><span class="p">,</span><span class="mh">0xa5</span><span class="p">,</span><span class="mh">0x90</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span><span class="mh">0x8d</span><span class="p">,</span><span class="mh">0xfa</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x76</span><span class="p">,</span><span class="mh">0xa5</span><span class="p">,</span><span class="mh">0x97</span><span class="p">};</span>

<span class="kt">int</span> <span class="nf">vik0t0rCallPayload</span><span class="p">(</span><span class="kt">uintptr_t</span> <span class="n">base_address</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">uintptr_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>                   <span class="c1">// Offset to the function</span>
    <span class="n">func_ptr</span> <span class="n">func</span> <span class="o">=</span> <span class="p">(</span><span class="n">func_ptr</span><span class="p">)(</span><span class="n">base_address</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

    <span class="c1">// Call the function at the offset</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Calling function...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">func</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>  <span class="c1">// Invoke the function</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The payload array is the original signature which called <code class="language-plaintext highlighter-rouge">RSA_public_decrypt</code> and caused the coredump. I was sending this to the function because I though that it would contain the commands to be executed, as the original xz utils backdoor, but later I found that the parameters are ignored.</p><p>Then we can compile with: <code class="language-plaintext highlighter-rouge">gcc -shared -o call.so -fPIC -g call.c</code></p><p>And now we are ready to attach with gdb and call our target function:</p><p>We need to find the address of <code class="language-plaintext highlighter-rouge">RSA_public_decrypt_hook</code>. We can use some of the other symbols defined at <code class="language-plaintext highlighter-rouge">liblzma.so</code>. For example <code class="language-plaintext highlighter-rouge">lzma_vli_size</code> is <code class="language-plaintext highlighter-rouge">0x450</code> bytes before.</p><p>First we get the address to lzma_vli_size</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>gef➤  info functions lzma_vli_size
All functions matching regular expression <span class="s2">"lzma_vli_size"</span>:

Non-debugging symbols:
0x00007f37e2fd1c30  lzma_vli_size@plt
0x00007f37e2fd63d0  lzma_vli_size
</pre></table></code></div></div><p>Then we calculate the address to <code class="language-plaintext highlighter-rouge">RSA_public_decrypt_hook</code></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>addr <span class="o">=</span> 0x7f37e2fd63d0 + 0x450 <span class="o">=</span> 0x7f37e2fd6820
</pre></table></code></div></div><p>And now we can load our shared library and call the function:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>call dlopen<span class="o">(</span><span class="s2">"/root/call.so"</span>,1<span class="o">)</span>
<span class="nb">break</span> <span class="k">*</span>0x7f37e2fd6820 
call vik0t0rCallPayload<span class="o">(</span>0x7f37e2fd6820<span class="o">)</span>
</pre></table></code></div></div><p>Now we just need to break on the instruction <code class="language-plaintext highlighter-rouge">call r8</code>:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c"># first print the assembly</span>
x/100i 0x7f37e2fd6820
<span class="c"># break on call r8</span>
<span class="nb">break </span>0x7f37e2fd693c
</pre></table></code></div></div><p>We see that r8 point to a RWX region, supicious at least…</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>gef➤  vmmap <span class="nv">$r8</span>
<span class="o">[</span> Legend:  Code | Heap | Stack <span class="o">]</span>
Start              End                Offset             Perm Path
0x00007f37e2d94000 0x00007f37e2d95000 0x0000000000000000 rwx 
</pre></table></code></div></div><p>Now we can dump that memory region to a file:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>dump memory payload.bin 0x00007f37e2d94000 0x00007f37e2d95000
</pre></table></code></div></div><h4 id="step-6-analyzing-the-shellcode"><span class="me-2">Step 6: Analyzing the shellcode</span><a href="#step-6-analyzing-the-shellcode" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Here there is the anotated ghidra decompilation of the shellcode:</p><p><a href="https://vik0t0r.github.io/assets/img/flareon11_3/payload1.png" class="popup img-link shimmer"><img src="https://vik0t0r.github.io/assets/img/flareon11_3/payload1.png" alt="img-description" width="1000" loading="lazy"></a></p><p>Looking through the shellcode and analyzing which syscalls we arrive to the conclusion that this is a backdoor which:</p><ol><li>opens a socket and connects to 10.0.2.15:1337 (we can see this ip by running the shellcode and sniffing the traffic)<li>reads 32 bytes (a chacha20 key) from the socket<li>reads 12 bytes (chacha20 nonce) from the socket<li>reads 4 bytes = an integer N (length of the path to read)<li>reads N bytes from the socket (path of the file to read)<li>opens the file<li>reads up to 128 bytes from the file<li>strlen’s the file contents<li>chacha20 encrypt the file<li>send the file to the socket</ol><p>The coredump happens after the execution of this payload, so the ciphered file contents must exist somewhere on the coredump.</p><h4 id="step-7-interacting-with-the-shellcode"><span class="me-2">Step 7: Interacting with the shellcode</span><a href="#step-7-interacting-with-the-shellcode" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>For dynamically analyzing the shellcode I added the target <code class="language-plaintext highlighter-rouge">sudo ip addr add 10.0.2.15/24 dev enp0s3</code> and wrote the following python script (with the help of chatgpt of course), the key and nonce are extracted from the core dump, it is explained on the next section:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">socket</span>
<span class="kn">import</span> <span class="n">struct</span>

<span class="k">def</span> <span class="nf">recv_all</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Receive exactly `length` bytes from the socket.</span><span class="sh">"""</span>
    <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">''</span>
    <span class="k">while</span> <span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">:</span>
        <span class="n">packet</span> <span class="o">=</span> <span class="n">sock</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>  <span class="c1"># Get what's remaining
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">packet</span><span class="p">:</span>
            <span class="c1"># Connection closed or error
</span>            <span class="k">raise</span> <span class="nc">ConnectionError</span><span class="p">(</span><span class="sh">"</span><span class="s">Connection closed before receiving all data</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">+=</span> <span class="n">packet</span>
    <span class="k">return</span> <span class="n">data</span>

<span class="c1"># Function to generate a fixed ChaCha20 key and nonce
</span><span class="k">def</span> <span class="nf">get_fixed_chacha20_key_nonce</span><span class="p">():</span>
    <span class="c1">#key = b'\x22' * 32  # 32 bytes key of all 2s
#    key = bytes.fromhex("94 3d f6 38 a8 18 13 e2 de 63 18 a5 07 f9 a0 ba 2d bb 8a 7b a6 36 66 d0 8d 11 a6 5e c9 14 d6 6f".strip(" "))
#    nonce = bytes.fromhex("f2 36 83 9f 4d cd 71 1a 52 86 29 55".strip(" "))
</span>    <span class="n">key</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="nf">fromhex</span><span class="p">(</span><span class="sh">"</span><span class="s">8d ec 91 12 eb 76 0e da 7c 7d 87 a4 43 27 1c 35 d9 e0 cb 87 89 93 b4 d9 04 ae f9 34 fa 21 66 d7</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">nonce</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="nf">fromhex</span><span class="p">(</span><span class="sh">"</span><span class="s">11 11 11 11 11 11 11 11 11 11 11 11</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1">#nonce = b'\x11' * 12  # 12 bytes nonce of all 0s
</span>    <span class="k">return</span> <span class="n">key</span><span class="p">,</span> <span class="n">nonce</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Create a socket
</span>    <span class="n">server_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">server_socket</span><span class="p">.</span><span class="nf">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">server_socket</span><span class="p">.</span><span class="nf">bind</span><span class="p">((</span><span class="sh">'</span><span class="s">10.0.2.15</span><span class="sh">'</span><span class="p">,</span> <span class="mi">1337</span><span class="p">))</span>
    <span class="n">server_socket</span><span class="p">.</span><span class="nf">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Server listening on 10.0.2.15:1337</span><span class="sh">'</span><span class="p">)</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">client_socket</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">server_socket</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Connection accepted from </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># Get the fixed ChaCha20 key and nonce
</span>        <span class="n">key</span><span class="p">,</span> <span class="n">nonce</span> <span class="o">=</span> <span class="nf">get_fixed_chacha20_key_nonce</span><span class="p">()</span>

        <span class="c1"># Send the 32-byte key and 12-byte nonce
</span>        <span class="n">client_socket</span><span class="p">.</span><span class="nf">sendall</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">client_socket</span><span class="p">.</span><span class="nf">sendall</span><span class="p">(</span><span class="n">nonce</span><span class="p">)</span>

        <span class="c1"># Prepare the string to send
</span>        <span class="n">string_to_send</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="s">/a.txt</span><span class="sh">"</span>
        <span class="n">string_length</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">string_to_send</span><span class="p">)</span>

        <span class="c1"># Send a 4-byte uint32 (length of the string)
</span>        <span class="n">client_socket</span><span class="p">.</span><span class="nf">sendall</span><span class="p">(</span><span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">'</span><span class="s">!I</span><span class="sh">'</span><span class="p">,</span> <span class="n">string_length</span><span class="p">))</span>

        <span class="c1"># Send the actual string
</span>        <span class="n">client_socket</span><span class="p">.</span><span class="nf">sendall</span><span class="p">(</span><span class="n">string_to_send</span><span class="p">)</span>

        <span class="c1"># Wait to receive a 4-byte uint32 (length of buffer to receive)
</span>        <span class="n">buffer_length_data</span> <span class="o">=</span> <span class="nf">recv_all</span><span class="p">(</span><span class="n">client_socket</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Received: </span><span class="sh">"</span><span class="p">,</span> <span class="n">buffer_length_data</span><span class="p">)</span>
        <span class="n">buffer_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">.</span><span class="nf">from_bytes</span><span class="p">(</span><span class="n">buffer_length_data</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="sh">"</span><span class="s">little</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Receiving n bytes: </span><span class="sh">"</span><span class="p">,</span> <span class="n">buffer_length</span><span class="p">)</span>
        <span class="c1"># Receive the encrypted buffer
</span>        <span class="n">encrypted_message</span> <span class="o">=</span> <span class="nf">recv_all</span><span class="p">(</span><span class="n">client_socket</span><span class="p">,</span> <span class="n">buffer_length</span><span class="p">)</span>

        <span class="c1"># Decrypt the message using ChaCha20
</span>        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Received bytes: </span><span class="si">{</span><span class="n">encrypted_message</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="c1"># Close the client connection
</span>        <span class="n">client_socket</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>

</pre></table></code></div></div><p>I also tried to decipher the received buffer unsuccesfully. They must be using a modified version of the chacha20 cipher!</p><h4 id="step-8-recovering-secrest-from-the-stack"><span class="me-2">Step 8: Recovering secrest from the stack</span><a href="#step-8-recovering-secrest-from-the-stack" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>To find the location for the key, we will analyze the stack locations and try to find them on the coredump.</p><p>In the following image see how key, nonce, PATH and readedFileContents are one after another on the stack:</p><p><a href="https://vik0t0r.github.io/assets/img/flareon11_3/stack.png" class="popup img-link shimmer"><img src="https://vik0t0r.github.io/assets/img/flareon11_3/stack.png" alt="img-description" width="1000" loading="lazy"></a></p><p>Now we print the stack from the core dump, see how <code class="language-plaintext highlighter-rouge">/root/certificate_authority_signing_key.txt</code> seems like the exfiltrated file, so it must be the offset for PATH:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre><td class="rouge-code"><pre>gdb /usr/sbin/sshd /mnt/var/lib/systemd/coredump/sshd.core.93794.0.0.11.1725917676

gef➤  hexdump byte <span class="nv">$rsp</span><span class="nt">-0x1500</span> <span class="nt">--size</span> 0x400

x00007ffcc6600998     04 5f 78 19 4a 7f 00 00 d0 0a 7b 19 00 00 00 80    ._x.J.....<span class="o">{</span>.....
0x00007ffcc66009a8     02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007ffcc66009b8     00 04 00 00 00 00 00 00 00 20 01 19 4a 7f 00 00    ......... ..J...
0x00007ffcc66009c8     d0 0a 7b 19 4a 7f 00 00 00 00 00 00 00 00 00 00    ..<span class="o">{</span>.J...........
0x00007ffcc66009d8     75 60 78 19 4a 7f 00 00 02 00 00 00 00 00 00 00    u<span class="sb">`</span>x.J...........
0x00007ffcc66009e8     02 00 00 90 00 00 00 00 60 0a 60 c6 <span class="nb">fc </span>7f 00 00    ........<span class="sb">`</span>.<span class="sb">`</span>.....
0x00007ffcc66009f8     00 00 00 00 00 00 00 00 00 00 00 00 02 00 00 90    ................
0x00007ffcc6600a08     02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007ffcc6600a18     70 0a 60 c6 <span class="nb">fc </span>7f 00 00 00 00 00 00 00 00 00 00    p.<span class="sb">`</span>.............
0x00007ffcc6600a28     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007ffcc6600a38     00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007ffcc6600a48     00 00 00 10 00 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007ffcc6600a58     30 90 58 6d b4 55 00 00 b0 2e 60 c6 <span class="nb">fc </span>7f 00 00    0.Xm.U....<span class="sb">`</span>.....
0x00007ffcc6600a68     a4 6c 78 19 4a 7f 00 00 b0 18 7b 19 4a 7f 00 00    .lx.J.....<span class="o">{</span>.J...
0x00007ffcc6600a78     0d 8e 1e 82 00 00 00 00 a0 f1 77 c6 <span class="nb">fc </span>7f 00 00    ..........w.....
0x00007ffcc6600a88     b8 f1 77 c6 <span class="nb">fc </span>7f 00 00 44 0b 60 c6 <span class="nb">fc </span>7f 00 00    ..w.....D.<span class="sb">`</span>.....
0x00007ffcc6600a98     38 42 eb 18 4a 7f 00 00 02 00 00 00 00 00 00 00    8B..J...........
0x00007ffcc6600aa8     38 42 eb 18 4a 7f 00 00 00 00 00 00 00 00 00 00    8B..J...........
0x00007ffcc6600ab8     40 10 60 c6 <span class="nb">fc </span>7f 00 00 25 00 00 00 00 00 00 00    @.<span class="sb">`</span>.....%.......
0x00007ffcc6600ac8     c0 11 60 c6 <span class="nb">fc </span>7f 00 00 57 71 7c 6c b4 55 00 00    ..<span class="sb">`</span>.....Wq|l.U..
0x00007ffcc6600ad8     55 71 7c 6c b4 55 00 00 02 00 00 00 00 00 00 00    Uq|l.U..........
0x00007ffcc6600ae8     <span class="nb">dd </span>d9 e8 18 4a 7f 00 00 4d 71 7c 6c b4 55 00 00    ....J...Mq|l.U..
0x00007ffcc6600af8     00 00 00 00 4a 7f 00 00 68 0d 00 00 00 00 00 00    ....J...h.......
0x00007ffcc6600b08     00 00 00 00 4a 7f 00 00 00 00 00 00 00 00 00 00    ....J...........
0x00007ffcc6600b18     00 00 00 00 <span class="nb">fc </span>7f 00 00 00 00 00 00 20 00 00 00    ............ ...
0x00007ffcc6600b28     00 00 00 00 02 00 00 00 4d 71 7c 6c b4 55 00 00    ........Mq|l.U..
0x00007ffcc6600b38     00 00 00 00 03 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007ffcc6600b48     00 00 00 00 02 00 00 00 ff ff ff ff ff ff ff ff    ................
0x00007ffcc6600b58     00 00 00 00 00 00 00 00 ff ff ff ff ff ff ff ff    ................
0x00007ffcc6600b68     00 00 00 00 00 00 00 00 57 71 7c 6c b4 55 00 00    ........Wq|l.U..
0x00007ffcc6600b78     0a 00 00 00 00 00 00 00 34 ca 7b 6c b4 55 00 00    ........4.<span class="o">{</span>l.U..
0x00007ffcc6600b88     38 42 eb 18 4a 7f 00 00 54 71 7c 6c b4 55 00 00    8B..J...Tq|l.U..
0x00007ffcc6600b98     00 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00    ................
0x00007ffcc6600ba8     30 11 60 c6 <span class="nb">fc </span>7f 00 00 e0 02 00 19 4a 7f 00 00    0.<span class="sb">`</span>.........J...
0x00007ffcc6600bb8     40 10 60 c6 <span class="nb">fc </span>7f 00 00 25 00 00 00 00 00 00 00    @.<span class="sb">`</span>.....%.......
0x00007ffcc6600bc8     02 00 00 00 00 00 00 00 30 11 60 c6 <span class="nb">fc </span>7f 00 00    ........0.<span class="sb">`</span>.....
0x00007ffcc6600bd8     28 00 00 00 30 00 00 00 a0 12 60 c6 <span class="nb">fc </span>7f 00 00    <span class="o">(</span>...0.....<span class="sb">`</span>.....
0x00007ffcc6600be8     8d ec 91 12 eb 76 0e da 7c 7d 87 a4 43 27 1c 35    .....v..|<span class="o">}</span>..C<span class="s1">'.5
0x00007ffcc6600bf8     d9 e0 cb 87 89 93 b4 d9 04 ae f9 34 fa 21 66 d7    ...........4.!f.
0x00007ffcc6600c08     11 11 11 11 11 11 11 11 11 11 11 11 20 00 00 00    ............ ...
0x00007ffcc6600c18     2f 72 6f 6f 74 2f 63 65 72 74 69 66 69 63 61 74    /root/certificat
0x00007ffcc6600c28     65 5f 61 75 74 68 6f 72 69 74 79 5f 73 69 67 6e    e_authority_sign
0x00007ffcc6600c38     69 6e 67 5f 6b 65 79 2e 74 78 74 00 ff ff ff ff    ing_key.txt.....
0x00007ffcc6600c48     00 00 00 00 00 00 00 00 f0 0d 60 c6 fc 7f 00 00    ..........`.....
0x00007ffcc6600c58     01 00 00 00 00 00 00 00 05 17 60 c6 fc 7f 00 00    ..........`.....
0x00007ffcc6600c68     ff ff ff ff 00 00 00 00 c0 de e3 18 4a 7f 00 00    ............J...
0x00007ffcc6600c78     00 20 01 19 4a 7f 00 00 00 00 00 00 00 00 00 00    . ..J...........
0x00007ffcc6600c88     00 00 00 00 00 00 00 00 1e 00 00 00 00 00 00 00    ................
0x00007ffcc6600c98     b1 49 78 19 4a 7f 00 00 00 00 00 00 00 00 00 00    .Ix.J...........
0x00007ffcc6600ca8     30 11 60 c6 fc 7f 00 00 a8 0c 00 00 00 00 00 00    0.`.............
0x00007ffcc6600cb8     a8 0c 00 00 00 00 00 00 00 10 00 00 00 00 00 00    ................
0x00007ffcc6600cc8     30 00 00 00 30 00 00 00 98 21 60 c6 fc 7f 00 00    0...0....!`.....
0x00007ffcc6600cd8     d0 20 60 c6 fc 7f 00 00 e0 0d 60 c6 fc 7f 00 00    . `.......`.....
0x00007ffcc6600ce8     ab e5 78 19 4a 7f 00 00 fc ec e0 18 4a 7f 00 00    ..x.J.......J...
0x00007ffcc6600cf8     10 00 00 00 00 00 00 00 e0 2a 01 19 4a 7f 00 00    .........*..J...
0x00007ffcc6600d08     00 00 00 00 00 00 00 00 e0 0d 60 c6 fc 7f 00 00    ..........`.....
0x00007ffcc6600d18     a9 f6 34 08 42 2a 9e 1c 0c 03 a8 08 94 70 bb 8d    ..4.B*.......p..
0x00007ffcc6600d28     aa dc 6d 7b 24 ff 7f 24 7c da 83 9e 92 f7 07 1d    ..m{$..$|.......
0x00007ffcc6600d38     02 63 90 2e c1 58 00 00 d0 b4 58 6d b4 55 00 00    .c...X....Xm.U..
0x00007ffcc6600d48     20 ea 78 19 4a 7f 00 00 d0 b4 58 6d b4 55 00 00     .x.J.....Xm.U..
0x00007ffcc6600d58     30 d1 77 19 4a 7f 00 00 f0 cb 77 19 4a 7f 00 00    0.w.J.....w.J...
0x00007ffcc6600d68     e0 2a 01 19 4a 7f 00 00 00 20 01 19 4a 7f 00 00    .*..J.... ..J...
0x00007ffcc6600d78     d0 0a 7b 19 4a 7f 00 00 ac f8 18 43 c6 70 80 96    ..{.J......C.p..
0x00007ffcc6600d88     ac f8 4c a6 e9 cd ed 97 00 00 00 00 4a 7f 00 00    ..L.........J...
</span></pre></table></code></div></div><p>Once we have got the offset for PATH we can calculate the relative offset for the other variables and get:</p><ul><li>key = <code class="language-plaintext highlighter-rouge">8d ec 91 12 eb 76 0e da 7c 7d 87 a4 43 27 1c 35 d9 e0 cb 87 89 93 b4 d9 04 ae f9 34 fa 21 66 d7</code><li>nonce = <code class="language-plaintext highlighter-rouge">11 11 11 11 11 11 11 11 11 11 11 11</code><li>readedFileContents = <code class="language-plaintext highlighter-rouge">a9 f6 34 08 42 2a 9e 1c 0c 03 a8 08 94 70 bb 8d aa dc 6d 7b 24 ff 7f 24 7c da 83 9e 92 f7 07 1d</code></ul><h4 id="step-9-deciphering-the-flag"><span class="me-2">Step 9: Deciphering the flag</span><a href="#step-9-deciphering-the-flag" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Finally I just wrote a python script to decode the flag. The script needs to calculate the cryptostream to XOR with our readedFileContents.</p><p>To get the cryptostream I called the previous python script given the key and nonce used and reading a file full of <code class="language-plaintext highlighter-rouge">A</code> characters. That way when we XOR the returned ciphered data with all <code class="language-plaintext highlighter-rouge">A</code> we get the cryptostream used for ciphering.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="n">ciphertext_core</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">.</span><span class="nf">fromhex</span><span class="p">(</span><span class="sh">"</span><span class="s">a9 f6 34 08 42 2a 9e 1c 0c 03 a8 08 94 70 bb 8d aa dc 6d 7b 24 ff 7f 24 7c da 83 9e 92 f7 07 1d</span><span class="sh">"</span><span class="p">)</span>


<span class="n">ciphertext</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x9b\xc2\x05</span><span class="s">92</span><span class="se">\x12\x80</span><span class="s">&gt;%#</span><span class="se">\xd8</span><span class="sh">'</span><span class="se">\x8a</span><span class="s">B</span><span class="se">\x8f\xa2\x8f\xa9</span><span class="s">Uz</span><span class="se">\x03\xd2</span><span class="s">_</span><span class="se">\x17</span><span class="s">X</span><span class="se">\xb6\xad\xb1\xfd\xd5</span><span class="s">)1I</span><span class="se">\xa4\x89\x02</span><span class="s">4Lt</span><span class="se">\x06</span><span class="s">4</span><span class="se">\t\xe2\xf3\x8f\xac</span><span class="s">;</span><span class="se">\xeb\xc1</span><span class="s">j4</span><span class="se">\xf1\xfb</span><span class="s">?h</span><span class="se">\xf2\x05\xcf</span><span class="s">3_</span><span class="se">\xf6\x83\xc2\x17\x9b\xc2\x05</span><span class="s">92</span><span class="se">\x12\x80</span><span class="s">&gt;%#</span><span class="se">\xd8</span><span class="sh">'</span><span class="se">\x8a</span><span class="s">B</span><span class="se">\x8f\xa2\x8f\xa9</span><span class="s">Uz</span><span class="se">\x03\xd2</span><span class="s">_</span><span class="se">\x17</span><span class="s">X</span><span class="se">\xb6\xad\xb1\xfd\xd5</span><span class="s">)1I</span><span class="se">\xa4\x89\x02</span><span class="s">4Lt</span><span class="se">\x06</span><span class="s">4</span><span class="se">\t\xe2\xf3\x8f\xac</span><span class="s">;</span><span class="se">\xeb\xc1</span><span class="s">j4</span><span class="se">\xf1\xfb</span><span class="s">?h</span><span class="se">\xf2\x05\xcf</span><span class="s">3_</span><span class="se">\xf6\x83\xc2\x17</span><span class="sh">"</span>
<span class="n">cleartext</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="o">*</span><span class="mi">128</span>

<span class="nf">print</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">cleartext</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">xor_bytes</span><span class="p">(</span><span class="n">bytes1</span><span class="p">,</span> <span class="n">bytes2</span><span class="p">):</span>
    <span class="c1"># Use zip to pair corresponding bytes, apply XOR, and return a new bytes object
</span>    <span class="k">return</span> <span class="nf">bytes</span><span class="p">(</span><span class="n">b1</span> <span class="o">^</span> <span class="n">b2</span> <span class="k">for</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">bytes1</span><span class="p">,</span> <span class="n">bytes2</span><span class="p">))</span>

<span class="n">cryptostream</span> <span class="o">=</span> <span class="nf">xor_bytes</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">,</span> <span class="n">cleartext</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Cryptostream: </span><span class="sh">"</span><span class="p">,</span> <span class="n">cryptostream</span><span class="p">.</span><span class="nf">hex</span><span class="p">())</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">xor_bytes</span><span class="p">(</span><span class="n">cryptostream</span><span class="p">,</span> <span class="n">ciphertext_core</span><span class="p">))</span>
</pre></table></code></div></div><p>And we get our precious flag: <code class="language-plaintext highlighter-rouge">supp1y_cha1n_sund4y@flare-on.com</code></p><h2 id="continuation"><span class="me-2">Continuation</span><a href="#continuation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The last post will be coming soon</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="//categories/hacking/">Hacking</a>, <a href="//categories/software/">Software</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="//tags/hacking/" class="post-tag no-text-decoration" >hacking</a> <a href="//tags/software/" class="post-tag no-text-decoration" >software</a> <a href="//tags/capture-the-flag/" class="post-tag no-text-decoration" >capture the flag</a> <a href="//tags/write-up/" class="post-tag no-text-decoration" >write-up</a> <a href="//tags/reverse-engineering/" class="post-tag no-text-decoration" >reverse engineering</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Flare-On%2011%20Write-Up%20Part%203%20-%20vik0t0r&url=https%3A%2F%2Fvik0t0r.github.io%2Fposts%2Fflare-on-11-write-up-part-3%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Flare-On%2011%20Write-Up%20Part%203%20-%20vik0t0r&u=https%3A%2F%2Fvik0t0r.github.io%2Fposts%2Fflare-on-11-write-up-part-3%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fvik0t0r.github.io%2Fposts%2Fflare-on-11-write-up-part-3%2F&text=Flare-On%2011%20Write-Up%20Part%203%20-%20vik0t0r" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/mitm-flutter-apps-on-android-emulator/">Mitm flutter apps on android emulator</a><li class="text-truncate lh-lg"> <a href="/posts/flare-on-11-write-up-part-2/">Flare-On 11 Write-Up Part 2</a><li class="text-truncate lh-lg"> <a href="/posts/flare-on-11-write-up-part-3/">Flare-On 11 Write-Up Part 3</a><li class="text-truncate lh-lg"> <a href="/posts/flare-on-11-write-up-part-1/">Flare-On 11 Write-Up Part 1</a><li class="text-truncate lh-lg"> <a href="/posts/some-cool-photos-which-can-be-use-as-wallapapers/">Some cool photos which can be use as Wallpapers</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/hacking/">hacking</a> <a class="post-tag btn btn-outline-primary" href="/tags/reverse-engineering/">reverse engineering</a> <a class="post-tag btn btn-outline-primary" href="/tags/software/">software</a> <a class="post-tag btn btn-outline-primary" href="/tags/capture-the-flag/">capture the flag</a> <a class="post-tag btn btn-outline-primary" href="/tags/write-up/">write-up</a> <a class="post-tag btn btn-outline-primary" href="/tags/android/">android</a> <a class="post-tag btn btn-outline-primary" href="/tags/golang/">golang</a> <a class="post-tag btn btn-outline-primary" href="/tags/electronics/">electronics</a> <a class="post-tag btn btn-outline-primary" href="/tags/flutter/">flutter</a> <a class="post-tag btn btn-outline-primary" href="/tags/frida/">frida</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/flare-on-11-write-up-part-2/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1733069220" data-df="ll" > Dec 1, 2024 </time><h4 class="pt-0 my-2">Flare-On 11 Write-Up Part 2</h4><div class="text-muted"><p>This is the second post in my Flare-On 11 series. If you haven’t already, I recommend checking out the previous writeup to get up to speed. As with the first post, you can find supplementary resou...</p></div></div></a></article><article class="col"> <a href="/posts/flare-on-11-write-up-part-1/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1732378020" data-df="ll" > Nov 23, 2024 </time><h4 class="pt-0 my-2">Flare-On 11 Write-Up Part 1</h4><div class="text-muted"><p>Over the past few weeks, I took part in the eleventh FLARE-ON Reverse Engineering Capture-the-Flag (CTF) competition. I managed to solve 6 out of the 10 challenges in this year’s Flare-On, picking...</p></div></div></a></article><article class="col"> <a href="/posts/mitm-flutter-apps-on-android-emulator/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1745500380" data-df="ll" > Apr 24, 2025 </time><h4 class="pt-0 my-2">Mitm flutter apps on android emulator</h4><div class="text-muted"><p>Introduction Analyzing network traffic from Flutter Android apps can be tricky. In this post, we’ll walk through how to intercept and inspect traffic from a Flutter app running on an Android Virtua...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="//posts/flare-on-11-write-up-part-2/" class="btn btn-outline-primary" aria-label="Older" ><p>Flare-On 11 Write-Up Part 2</p></a> <a href="//posts/mitm-flutter-apps-on-android-emulator/" class="btn btn-outline-primary" aria-label="Newer" ><p>Mitm flutter apps on android emulator</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://github.com/vik0t0r">Victor de Pedraza Ajenjo</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/hacking/">hacking</a> <a class="post-tag btn btn-outline-primary" href="/tags/reverse-engineering/">reverse engineering</a> <a class="post-tag btn btn-outline-primary" href="/tags/software/">software</a> <a class="post-tag btn btn-outline-primary" href="/tags/capture-the-flag/">capture the flag</a> <a class="post-tag btn btn-outline-primary" href="/tags/write-up/">write-up</a> <a class="post-tag btn btn-outline-primary" href="/tags/android/">android</a> <a class="post-tag btn btn-outline-primary" href="/tags/golang/">golang</a> <a class="post-tag btn btn-outline-primary" href="/tags/electronics/">electronics</a> <a class="post-tag btn btn-outline-primary" href="/tags/flutter/">flutter</a> <a class="post-tag btn btn-outline-primary" href="/tags/frida/">frida</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
